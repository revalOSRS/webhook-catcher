# Database Migration: Add account_hash to osrs_accounts

## Overview
Add the `account_hash` field to the `osrs_accounts` table to support RuneLite plugin authentication and player identification.

## Migration SQL

```sql
-- Add account_hash field to osrs_accounts table
ALTER TABLE osrs_accounts
ADD COLUMN IF NOT EXISTS account_hash TEXT;

-- Optional: Add index for faster lookups by account_hash
CREATE INDEX IF NOT EXISTS idx_osrs_accounts_account_hash 
ON osrs_accounts(account_hash);

-- Optional: Add comment for documentation
COMMENT ON COLUMN osrs_accounts.account_hash IS 'Unique hash from RuneLite plugin for player identification';
```

## Field Details

**Column Name:** `account_hash`  
**Type:** `TEXT`  
**Nullable:** `YES` (NULL allowed for existing accounts)  
**Purpose:** Stores the unique hash generated by the RuneLite plugin for each player

## Usage

The `account_hash` will be:
- Set during first SYNC from RuneLite plugin
- Used to match future SYNC events to the correct account
- Updated if the player re-installs or uses a different device (using COALESCE logic)

## Update Logic in Code

```typescript
// From sync.service.ts upsertOsrsAccount()
ON CONFLICT (username) 
DO UPDATE SET
  account_hash = COALESCE($accountHash, osrs_accounts.account_hash),
  account_type = $accountType,
  last_synced_at = NOW()
```

This ensures:
- If a new hash is provided, it updates
- If hash is NULL, keeps existing hash
- Never overwrites with NULL

## Verification

After running migration, verify:

```sql
-- Check column was added
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'osrs_accounts' 
  AND column_name = 'account_hash';

-- Check index was created
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'osrs_accounts' 
  AND indexname = 'idx_osrs_accounts_account_hash';
```

## Rollback (if needed)

```sql
-- Remove index
DROP INDEX IF EXISTS idx_osrs_accounts_account_hash;

-- Remove column
ALTER TABLE osrs_accounts
DROP COLUMN IF EXISTS account_hash;
```

## Notes

- This is a non-breaking change (column is nullable)
- Existing accounts will have NULL `account_hash` until they sync via RuneLite
- No data migration needed
- No impact on existing queries
- Safe to run on production

